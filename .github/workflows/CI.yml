name: CI

on:
  push:
    # ignore pushes to main as all changes go via a pull request
    branches-ignore:
      - main
    paths-ignore:
      - '.devcontainer/**'
      - '.vscode/settings.json'
      - '.editorconfig'
      - 'CONTRIBUTING.md'
      - 'NuGet.md'
      - 'README.md'
      - 'build.ps1'
      - 'build.sh'
      - 'testgen.sh'
    tags-ignore:
      - '*.*.*'
  pull_request:
    paths-ignore:
      - '.devcontainer/**'
      - '.vscode/settings.json'
      - '.editorconfig'
      - 'CONTRIBUTING.md'
      - 'NuGet.md'
      - 'README.md'
      - 'build.ps1'
      - 'build.sh'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  # Disable sending usage data to Microsoft
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  # Disable telemetry message
  DOTNET_NOLOGO: true
  # Stop wasting time caching packages
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  # Do not extract XML documentation files from nuget packages
  NUGET_XMLDOC_MODE: skip
  PROJECT_CONFIGURATION: Release

jobs:
  build:
    name: Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]
    steps:
      - uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 7.0.x

      - name : dotnet restore
        run: dotnet restore

      - name: dotnet build
        run: dotnet build --configuration ${{ env.PROJECT_CONFIGURATION }} --no-restore

      - name: dotnet test
        run: dotnet test --no-restore --verbosity minimal

      - name: dotnet pack
        run: dotnet pack --no-build --configuration ${{ env.PROJECT_CONFIGURATION }}

      - name: Upload coverage reports to Codecov
        if: matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v3
